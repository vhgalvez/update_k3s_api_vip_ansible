---
- name: "Actualizar K3s para usar la IP VIP"
  hosts: all
  become: true
  gather_facts: false

  vars:
    vip_ip: "{{ api_vip | default('10.17.5.10') }}"
    k3s_service_path: "/etc/systemd/system/k3s.service"
    agent_service_path: "/etc/systemd/system/k3s-agent.service"
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    primer_master: "{{ groups['masters'][0] }}"

  tasks:

    # --- SOLO PRIMER MASTER ---
    - name: "üìå Verificar si es el primer master"
      debug:
        msg: "Soy el primer master"
      when: inventory_hostname == primer_master

    - name: "üîÑ Reconstruir archivo k3s.service en primer master"
      copy:
        dest: "{{ k3s_service_path }}"
        content: |
          [Unit]
          Description=Lightweight Kubernetes
          Wants=network-online.target
          After=network-online.target

          [Service]
          Type=notify
          ExecStartPre=-/sbin/modprobe br_netfilter
          ExecStartPre=-/sbin/modprobe overlay
          ExecStart=/opt/bin/k3s server --cluster-init --tls-san {{ inventory_hostname }} --tls-san {{ vip_ip }} --write-kubeconfig /etc/rancher/k3s/k3s.yaml --write-kubeconfig-mode 644
          Restart=always
          KillMode=process
          Delegate=yes
          LimitNOFILE=1048576
          LimitNPROC=infinity
          LimitCORE=infinity

          [Install]
          WantedBy=multi-user.target
      when: inventory_hostname == primer_master

    - name: "üßπ Borrar certificados TLS (regeneraci√≥n)"
      raw: |
        rm -rf /var/lib/rancher/k3s/server/tls
        rm -rf /var/lib/rancher/k3s/server/db/etcd-tmp
      when: inventory_hostname == primer_master

    - name: "‚ôªÔ∏è Reiniciar K3s en primer master"
      raw: |
        systemctl daemon-reexec
        systemctl daemon-reload
        systemctl restart k3s
      when: inventory_hostname == primer_master

    - name: "‚è≥ Esperar que API responda por VIP (primer master)"
      raw: |
        for i in $(seq 1 60); do
          curl -k --max-time 1 https://{{ vip_ip }}:6443/version >/dev/null 2>&1 && exit 0
          sleep 1
        done
        echo "‚ùå La API en {{ vip_ip }}:6443 no respondi√≥ en 60s"
      when: inventory_hostname == primer_master

    # --- WORKERS Y STORAGE ---
    - name: "üìù Reemplazar IP del API server en k3s-agent.service"
      raw: |
        sed -i "s|--server https://[^ ]\+|--server https://{{ vip_ip }}:6443|" {{ agent_service_path }}
      when: inventory_hostname not in groups['masters']

    - name: "‚ôªÔ∏è Reiniciar k3s-agent"
      raw: |
        systemctl daemon-reexec
        systemctl daemon-reload
        systemctl restart k3s-agent
      when: inventory_hostname not in groups['masters']

    - name: "üì° Verificar que k3s-agent est√° activo"
      raw: |
        systemctl is-active k3s-agent || echo "‚ùå El agente k3s no est√° activo"
      when: inventory_hostname not in groups['masters']

    # --- RESTO DE MASTERS ---
    - name: "‚ûï A√±adir --tls-san en los dem√°s masters"
      raw: |
        grep -q -- "--tls-san {{ vip_ip }}" {{ k3s_service_path }} || \
        sed -i "/ExecStart=/ s|\(--tls-san [^ ]\+\)|\1 --tls-san {{ vip_ip }}|" {{ k3s_service_path }}
      when: inventory_hostname in groups['masters'] and inventory_hostname != primer_master

    - name: "üßπ Borrar TLS para regeneraci√≥n (otros masters)"
      raw: |
        rm -rf /var/lib/rancher/k3s/server/tls
        rm -rf /var/lib/rancher/k3s/server/db/etcd-tmp
      when: inventory_hostname in groups['masters'] and inventory_hostname != primer_master

    - name: "‚ôªÔ∏è Reiniciar K3s en otros masters"
      raw: |
        systemctl daemon-reexec
        systemctl daemon-reload
        systemctl restart k3s
      when: inventory_hostname in groups['masters'] and inventory_hostname != primer_master

    # --- VERIFICACI√ìN SOLO EN MASTERS ---
    - name: "üîç Verificar si kubeconfig usa la VIP (solo en masters)"
      raw: |
        if [ -f "{{ kubeconfig_path }}" ]; then
          grep 'server: https://{{ vip_ip }}:6443' "{{ kubeconfig_path }}" || echo "‚ùå kubeconfig sin VIP"
        else
          echo "‚ö†Ô∏è No existe kubeconfig (normal en agentes)"
        fi
      when: inventory_hostname in groups['masters']
      register: resultado_kubeconfig
      changed_when: false

    - name: "üì§ Mostrar resultado de verificaci√≥n"
      debug:
        var: resultado_kubeconfig.stdout_lines
      when: inventory_hostname in groups['masters']